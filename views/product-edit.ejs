<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Edit Product</title>
<link rel="stylesheet" href="/asset-admin/css/style.css" />
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
</head>
<body>
<div class="page-flex">
  <%- include('./partials/sidebar-admin') %>
  <div class="main-wrapper">
    <header><%- include('./partials/header-admin') %></header>
    <div class="container">
      <h2>Edit Product</h2>
      <form id="updateForm" enctype="multipart/form-data">
        <input type="hidden" id="productId" value="<%= product.id %>" />
        <div>
          <label>Name</label>
          <input type="text" id="name" value="<%= product.name %>" required />
        </div>
        <div>
          <label>Price</label>
          <input type="number" id="price" value="<%= product.price %>" required />
        </div>
        <div>
          <label>Category</label>
          <select id="categoryId" required></select>
        </div>
        <div>
          <label>Description</label>
          <textarea id="description"><%= product.description %></textarea>
        </div>
        <div>
          <label>Current Image</label><br/>
          <img src="<%= product.image %>" width="120"/>
        </div>
        <div>
          <label>Change Image</label>
          <input type="file" id="imageFile" accept="image/*"/>
        </div>
        <button type="submit">Update</button>
      </form>
    </div>
    <footer><%- include('./partials/footer-admin') %></footer>
  </div>
</div>

<script>
CKEDITOR.replace('description');

async function loadCategories(currentId) {
  const res = await fetch('/v1/categories');
  const categories = await res.json();
  const select = document.getElementById('categoryId');
  select.innerHTML = '';
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    if(c.id == currentId) opt.selected = true;
    select.appendChild(opt);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const currentCategoryId = "<%= product.categoryId %>";
  loadCategories(currentCategoryId);

  const form = document.getElementById('updateForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const productId = document.getElementById('productId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('name').value);
    formData.append('price', document.getElementById('price').value);
    formData.append('categoryId', document.getElementById('categoryId').value);
    formData.append('description', CKEDITOR.instances.description.getData());
    if(document.getElementById('imageFile').files.length>0)
      formData.append('imageFile', document.getElementById('imageFile').files[0]);

    const res = await fetch(`/v1/products/${productId}`, {
      method: 'PUT',
      body: formData
    });

    if(res.ok){
      alert('Product updated!');
      window.location.href='/admin/product';
    }else{
      const err = await res.json();
      console.error(err);
      alert('Failed to update product: '+err.message);
    }
  });
});
</script>
</body>
</html>
