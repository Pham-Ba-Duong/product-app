<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Products</title>
  <link rel="shortcut icon" href="/asset-admin/img/svg/logo.svg" type="image/x-icon" />
  <link rel="stylesheet" href="/asset-admin/css/style.css" />
</head>
<script src="https://unpkg.com/feather-icons"></script>

<body>
  <div class="layer"></div>
  <a class="skip-link sr-only" href="#skip-target">Skip to content</a>

  <div class="page-flex">
    <%- include('./partials/sidebar-admin') %>

      <div class="main-wrapper">
        <header><%- include('./partials/header-admin') %></header>

        <div class="container">
          <h2 class="main-title">Products</h2>

          <div class="d-flex justify-content-between">
            <a href="/admin/manage-product/create">
              <button class="button-btn">New Product</button>
            </a>
          </div>

          <div class="users-table table-wrapper">
            <input id="searchInput" type="text" placeholder="Search anything..." />

            <table class="posts-table">
              <thead>
                <tr class="users-table-info">
                  <th>Image</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Date</th>
                  <th>Comments</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="list-post-admin"></tbody>
            </table>
          </div>

          <div class="table-wrapper">
            <ul class="pagination justify-content-start"></ul>
          </div>
        </div>

        <footer class="footer"><%- include('./partials/footer-admin') %></footer>
      </div>
  </div>

  <script src="/asset-admin/js/script.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      getProductListDataAdmin();
      handleSearchProduct();
    });

    // Search
    const handleSearchProduct = () => {
      const searchInput = document.getElementById("searchInput");

      searchInput.addEventListener("keyup", async (e) => {
        const search = e.target.value;

        if (search.trim() === "") {
          getProductListDataAdmin();
          return;
        }

        const productApi = `/v1/products/search?q=${search}`;
        const response = await fetch(productApi);
        const data = await response.json();
        renderProducts(data);
      });
    };

    // Render product table
    const renderProducts = (products) => {
      const productList = document.getElementById("list-post-admin");
      let html = "";

      products.forEach((p) => {
        const createdAt = new Date(p.createdAt).toLocaleDateString();
        let image = p.image || "/asset-admin/img/default.png";

        html += `
            <tr id="trow_${p.id}">
              <td>
                <div class="categories-table-img">
                  <img src="${image}" alt="product" />
                </div>
              </td>
              <td>${p.name}</td>
              <td>${p.category ? p.category.name : "N/A"}</td>
              <td>${createdAt}</td>
              <td>
                <a href="/admin/product/${p.id}/comments">
                  <button class="btn btn-show-comment">Show</button>
                </a>
              </td>
              <td>
                <a href="/admin/product/update/${p.id}">
                  <button class="btn btn-edit">Edit</button>
                </a>
                |
                <button class="btn btn-delete" data-id="${p.id}">Delete</button>
              </td>
            </tr>
          `;
      });

      productList.innerHTML = html;

      // Delete event
      document.querySelectorAll(".btn-delete").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = btn.getAttribute("data-id");
          deleteProduct(id);
        });
      });
    };

    // Get all products
    const getProductListDataAdmin = async () => {
      const response = await fetch("/v1/products");
      const products = await response.json();
      renderProducts(products);
    };

    // Delete product
    const deleteProduct = async (id) => {
      if (!confirm("Are you sure?")) return;

      const response = await fetch(`/v1/products/${id}`, { method: "DELETE" });

      if (response.ok) {
        document.getElementById(`trow_${id}`).remove();
        alert("Deleted!");
      } else {
        alert("Delete failed!");
      }
    };
  </script>
</body>

</html>